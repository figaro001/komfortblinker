/*
 * MyKomfortBlinker_v1.04.cpp
 *
 * Created: 28.09.2016 14:01:50
 * Author : figaro
 */ 

#define F_CPU 4800000UL			// ???????? ??????? ???????????????? 4,8MHz

#include <avr/io.h>				// ??????????? ????????? ?????/?????? ? ??????????? ?? ???? ?? AVR
#include <util/delay.h>			// ??????? ??????? ?????? ????????. void _delay_us (double __us) ? void _delay_ms (double __ms)
#include <avr/eeprom.h>			// ?????????? ??? ?????? ? EEPROM
//#include <avr/interrupt.h>		// ?????????? ??????????
#include <stdint.h>				// ?????????? ????????? ????????? ????????????? ????? ? ????????. ????????:
								// uint8_t	u		- unsigned	- ???????????
								//			int		- integer	- ?????
								//			8					- ??????????? ???
								//			_t					- ???????????, ??? ??? ??????????? ? ?? ??????? ? ?? ????????? ? ???

#define Out_Links		PORTB3	// ?????????? ??? ?????? ?????? ???????????, ??????? ????????????? ??????????? ????? PORTB3
#define Out_Rechts		PORTB4	// ?????????? ??? ?????? ??????? ???????????, ??????? ????????????? ??????????? ????? PORTB4
#define Conf_Taste		PORTB5	// ?????????? ??? ?????? ????? ? ????? ???????????????? ?????????? Komfortblinker, ??????? ????????????? ??????????? ????? PORTB5

uint8_t EEMEM		  ee_Blinks;	// ?????????? ????????????? ?????????? ?????????? ???????? ???????????. ???????? ?? ????????? 0?04
uint8_t EEMEM   ee_Danke_Blinks;	// ?????????? ????????????? ?????????? ?????????? ???????? ???????? ? ?????? "???????". ???????? ?? ????????? 0?02
uint8_t EEMEM   ee_Pause_Blinks;	// ?????????? ????????????? ????? ????? ???????? ?????? ???????????. ???????? ?? ????????? 0?10 (10*50=500us ??? 0,5 ???????)
uint8_t EEMEM	  ee_Pause_Keys;	// ?????????? ????????????? ????? ????? ???????? ????????? ??????. ???????? ?? ????????? 0?10 (10*10=100ms ??? 0,1 ???????)
uint8_t EEMEM ee_init_conf_flag;	// ????, 0 - ????????? ????????????, ???????? ? EEPROM ??? ? ??? ????????? ??????? ???????? EEPROM ????? ???????????? ?????????? ?? ?????????. ????????????? ????? ???????? ??????????? ?????????? ???????? ? ?????? EEPROM.
uint8_t ee_flag			 = 0x00;	// ????, ????????? ????? ? "1" ?????????? ??? ?? ????????? ? ?????? ????????????.
uint8_t blink_flag		 = 0x00;	// ????, ????????? ????? ? ?? ??????? ???????? ?????????? ?????????? ?? ??????. unsigned ?????? ???????????. ? ???????? ?????????????
								// ? ??? ??????? ??? ????????? ??? ????, ? ?????? ? ???? ???? (char) ?????? ????? +127/-128, ?? ???? ???? ????????? ?? ?????? ??? ?? 0 ?? 255. ?????? ???? ?? ?????. ??? ??? unsigned
								// blink_flag = 1 - ??? ??????? ?????? ??????????
								// blink_flag = 2 - ??? ??????? ????? ??????????
								// blink_flag = 3 - ??? ??????? ????? "???????"
								// blink_flag = 4 - ???????? ????
								// blink_flag = 5 - ???? ???????? ? ?????? ????????????
								// blink_flag = 8 - ???????? ???????? ?????????? ???? ??? ???????? ? ???????? ?????????
uint8_t blink_counter	= 0x00;	// ???????, ?????? ???????? ?????????? ????????? ???????? ????????????
uint8_t my_key_state	= 0x00;	// ?????????? ??? ???????? ????????? ??????
uint8_t my_puls			= 0x00;	// ?????????? ??? ???????? ????????? ?????????? ?????????? ???????? (?????????? (Blinks 4), ??? "???????" (Danke_Blinks 2))
uint8_t not_state		= 0x00;	// ?????????? ??? ???????? ??????? ?????????????? ?????? ??????????? ???????????
uint8_t ee_counter		= 0x00;	// ?????????? ??? ?????????? ???????? ????????, ? ??????????? ??????????? ? EEPROM


uint8_t Not_Blink_State (void) // ???????? ?? ?????????????? ?????? ??????????? ???????????, ?.?. ???????? ???????? ????? ?????????? ? ?? ???????? ???????? ??????? ??????????? ???????? ???????? ?????? ???????????
{
	uint8_t j = 0; // ?????????? j
	if ((blink_flag == 0x01) && ((my_key_state | 0b11111110) == 0b11111110)) j	= 1; // ??????? ?????????? ??????, ???????? ???????? ???????????? ????? ???????? ????????, ?.?. ????????? ????????? ??? (OR) 2-? ?????? ?? "0"
	if ((blink_flag == 0x02) && ((my_key_state | 0b11111101) == 0b11111101)) j	= 1; // ??????? ?????????? ?????, ???????? ???????? ???????????? ?????? ???????? ????????, ?.?. ????????? ????????? ??? (OR) 1-? ?????? ?? "0"
	return j;
}

void Reset_Relay (void) // ???????????? ???????? ? ????????? ?????????, ????? ??? ????????? ? ?? ???? ??????? ??????????? ??? ????????
{
	 PORTB			&=	~(1<<Out_Links);	// ?????????? "0" ? ???? Aus_Links (PORTB3), ?.?. ????????? ?????????? ? ????????? ???? ??????????????? ????????? ?????? ???????????
											// ??? ??????  1 ? ????: PORTB |= 1 << Aus_Links, ?.?. ???????? ???????? ?????? ??????????? ????? ??????????;
	 PORTB			&=	~(1<<Out_Rechts);	// ?????????? "0" ? ???? Aus_Rechts (PORTB4), ?.?. ????????? ?????????? ? ????????? ???? ??????????????? ????????? ??????? ???????????
	 blink_flag		=				0x00;	// ???????? ????
	 blink_counter	=				0x00;	// ???????? ???????
	 my_puls		=				0x00;	// ???????? ?????????? ??? ???????? ????????? ?????????? ?????????? ????????
	 if (ee_flag == 0x00)					// ???? ????????? ? ?????? ????????, ?? ?????????? ????? (? ?????? ???????? ??????, ???????? ????? ???????)
	 {
		for (uint8_t i = 0; i < eeprom_read_byte(&ee_Pause_Blinks); i++)	// ??????????? ????? (4*10=40ms= 0,04s), ??? ????? ??????????? ?? ??????????????? ????????? ?????? ???????????, ????? ????, ??? ??????, ??????????, ??????????
		{																	// ??? ????????????? ????????? ????????? ???? ?? ???????? ?? ?????. ??? ???????, ????????? ???????????? ??????
			_delay_ms(10);
		}//for
	 }//if
}

uint8_t Get_Key_Data (void) // ???????????? ?????? ????????? ?????? ? ?????????????
{
	uint8_t k;							// ?????????? i
	do 
	{
		k = (PINB & 0b00100111);		// ??????? ?????????? ? "&" ?????????? ????????? ?????? ?????? 3-? ???????? (0b00000 "1" "1" "1"),
		if (ee_flag == 0x00)
		{
			for (uint8_t t = 0; t < eeprom_read_byte(&ee_Pause_Keys); t++)	// ??????????? ????? (100*10=1000us= 1ms), ??? ????? ??????????? ?? ??????????????? ????????? ?????? ???????????, ????? ????, ??? ??????, ??????????, ??????????
			{							// ??? ????????????? ????????? ????????? ???? ?? ???????? ?? ?????. ??? ???????, ????????? ???????????? ?????? ???????????
				_delay_us(100);			// ???? 100 ???????????
			}//for
		}//if
		else
		{
			_delay_ms(2);				// ???? 2 ????????????
		}//else
	} while (k != (PINB & 0b00100111)); // ?????????? i (????????? ?????? ?? ?????) ? ??????? ????????? ??????. ???? ????????? ??????, ??? ? ????? ?????? ?????,
										// ????????? ????? ? ?????? ????? ? ????? ????????? ???????? ??????, ????, ????????? ?????? ? ??????????. ???? ????????? ??????????,
										// ? ?????? ?? ???????????? ??? ??????? ?????????? ????????? ??????, ?? ?? ??????? "while" ??? "fulse" ?? ????????? ???????????? ?
	asm("wdr");							// ????? ??????????? ??????? WDT	
	return k;							// ?????????? ? ???????? ????????? ??????? ????????? ??????
}

uint8_t Get_Kurz_Lang_Druck (void)		// ???????????? ?????? ???????????? ??????? ??????. 2.
{
	uint8_t i = 0;
	do
	{
		my_key_state = Get_Key_Data();						// ???????? ????????? ??????
	} while ((my_key_state & 0b00100000) == 0b00100000);	// ???? ?????? ?? ??????, ?? ?????? ???? ??????? ??? ??????????? ??????
	
	while (((my_key_state | 0b11011111) == 0b11011111) && (i < 0xC8)) // (0xC8=200)200*2ms = !!! 3 ???????. ??????? ?????? 3 ???. ????????? ?? ???????? ???????. ?????????, ?????? ?????????? ?????????? 3?.
	{
		my_key_state = Get_Key_Data();	// ???????? ????????? ??????
		i++;							// ??????????? ??????? ?? 1 (???????? 10 ms)
	}
	return i;
}

uint8_t Get_Kurz_Lang_Counter (void)	// ???????????? ????? ???????? ??????? ? ???????? ???????? ??????? ??????. 1.
{
	uint8_t j = 0;
	blink_counter = Get_Kurz_Lang_Druck(); // ???????? ????? ?? 0 ?? 0xC8 (200)
	while ((blink_counter < 0xC8) && (j < 0xFE)) //??????? ??????????? ???????? ??????? (blink_counter < 0xC8), ??????????? ????????? ??????????? ??????? 254 (j < 0xFE).
	{
		j++;
		blink_counter = Get_Kurz_Lang_Druck();
	}
	return j;
}
	
void Blink_Relay (uint8_t pulsData)
{
	PORTB			|= (1<<Out_Links); 	// ???????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "1")
	PORTB			|= (1<<Out_Rechts);	// ???????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "1")
	blink_flag		= 0x05;				// ????????????? ???? ??? ??????????? ??????, ? ??????? ?? ?????????
	do 
	{
		if (blink_flag == 0x08)				// ?????????, ??? ?? ?????????? blink_flag ? 0?08, ?.?. ??? ????????, ??? ?????????? ??????? ??????? ??? ???????? ????? "????????", ?? ?? ??? ???????? ?????? ?????????? ???
		{
			if (my_key_state == 0b00000011)	// ?????????, ???????? ?? ???? !!!? ??????????? ?????? ???????? ????????????, ??? ????? ?? ????? ??? ?????????
			{
				Reset_Relay();
			}
		}
		else
		{
			my_key_state = Get_Key_Data();	// ?????????? ????????? ??????, ??? ????? ????????? 6 ? 3-?? ???????? 
											// 0b00100000 - ????????? ?? ?????????
											//     |  |---> ????????? ????		0 - ???? 1 - ???
											//     |------> ????? ????????????	1 - ???? 0 - ???
			if ((my_key_state | 0b11111011) == 0b11111011) // ??????? ????????, ???? ??????????
			{
				if (blink_counter >= pulsData)
				{ // ???????? ?????? ?????????? ???
					PORTB		&= ~(1<<Out_Links);		// ????????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "0")
					PORTB		&= ~(1<<Out_Rechts);	// ????????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "0")
					blink_flag	= 0x08;					// ????????? ???? ??? ?????????? ????????, ??? ?????????? ? ????...
				}
				else // ??? ?? ????????? ?????? ?????????? ???
				{
					blink_counter++;
					while ((my_key_state | 0b11111011) == 0b11111011) // ???????? ????????? ????
					{
						my_key_state = Get_Key_Data();		// ?????????? ????????? ??????, ??? ?????? ?????????, ?? ???? ?? ???????????? ?????? ??????????? ???????????
					} // while
				} // else
			} // if
		} // else
	} while (blink_flag == 0x05);
}

int main(void)	// ??????? main - ????? ????? ? ??????? ????????. void ??? ??? ?????? ??????? ?? ???????? ? ???????, ? ?????? ?????? main ????? ?? ????? ?????? ??????? ?????,
				//?????? void - ????????. ????????, ??????????? ????? ????? ?? ???? ?????? ?????????? ??? ??????????.
{/* ????????????? ?????? ?????-??????. ????????????? ????? B:
     Func5=In  Func4=Out  Func3=Out  Func2=In  Func1=In  Func0=In --- In - ????, Out - ?????
    State5=T  State4=0   State3=0   State2=T  State1=P  State0=P  --- 0 - ???? ???????? ??? ????? ? ???????? ? ?????, ? - ???? ???????? ??? ???? ? ????????? ? ?????? Hi-Z,
																      P - ???? ???????? ??? ???? ? ????????? ? ?????? PullUp
    PIN? (PINB)   - ??????? ??????. ?? ???? ????? ?????? ??????. ? ???????? PINx ?????????? ?????????? ? ???????? ??????? ?????????? ?????? ?? ??????? ?????,
				    ??? ??????????? ?? ???????? ?????. ??? ??? ???? ????? ?????? ??? ? ??? ?? ????? - ?????? ??????????????? ??? ???????? PINx
    DDRx (DDRB)   - ??????? ??????????? ?????. ???? ? ?????????? ?????? ??????? ????? ???? ???? ?????? ???? ???????
				    DDRBy=0 - ????? ???????? ??? ????
				    DDRBy=1 - ????? ???????? ?? ?????
    PORTx (PORTB) - ????? ?????????? ?????????? ??????. ????? ?? ??????????? ????? ?? ????, ?? ?? PORT ??????? ??? ????? (Hi-Z ??? PullUp)
				    ????? ????? ????????? ?? ?????, ?? ???????? ???????????????? ???? ? ???????? PORTx ?????????? ????????? ??????. ???? PORTxy=1 ?? ?? ?????? ???1, ???? PORTxy=0 ?? ?? ?????? ??? "0"
				    ????? ????? ????????? ?? ????, ?? ???? PORTxy=0, ?? ????? ? ?????? Hi-Z. ???? PORTxy=1 ?? ????? ? ?????? PullUp ? ????????? ?????????? ? 100? ?? ??????? */
 
 //DDRB &= ~(1<<PORTB2|1<<PORTB1|1<<PORTB0);	// ????????????? ????? PORTB2, PORTB1 ? PORTB0 ??? ?????. ?? ????? ?????? ??????, ?.?. ??? ?? ????????? ?????
 DDRB  |= 1<<Out_Rechts|1<<Out_Links;			// ????????????? ????? PORTB4 ? PORTB3 ??? ??????
 //PORTB |= 1<<PORTB1|1<<PORTB0;				// ?????????? ? ????? PORTB1 ? PORTB0 "1", ?.?. ??????????? ?? ????? ?????????? ????????????? ???????????????? (100???) ? +5V. ???? ?? ??? ????????? ????? +4,7v
 PORTB |= 1<<Conf_Taste|1<<PORTB1|1<<PORTB0;	// ???? "RESET" (PORTB5) ?????????? ??? ????, ?????????? ? ????? PORTB5 "1", ?.?. ??????????? ?? ????? ?????????? ????????????? ???????????????? (100???) ? +5V
												// ??? ????????? ?? ???? ????? ??????????? "0" - ????? ?????????? ? ????? ????????? ???????? ?? ?????????
 //PORTB &= ~(1<<PORTB2);						// ???????? ?? ????????? (????? ? ?????? ???? ? ? ?????? Hi-Z), ???????? ?????? ?????????? ?? ???? ?????? ?????????? "0"
 
 // ????????????? ??????????? ??????? (?????????? ?? CodeVisionAVR, ????? ?????? ??? ??? ???????? ? ??? ????????? ???????????????? :) ) ????? ??? ?????????????? ????????? ???????????????? ? ???????????? ?????????
 // Watchdog Timer Prescaler: OSC/1024k
 // Watchdog Timer interrupt: Off
 //#pragma optsize-
 WDTCR=0x39; // 0b00111001
 WDTCR=0x29; // 0b00101001
 //#ifdef _OPTIMIZE_SIZE_
 //#pragma optsize+
 //#endif 
 
 // Global enable interrupts
 // sei(); // ????????? ??????????
 
 if (eeprom_read_byte(&ee_init_conf_flag) != 0x04) // ????????? ????????? ???????????? ?  EEPROM
 {
	 eeprom_write_byte(&ee_Blinks,			0x04);	// ????????????? ?????????? ?????????? ???????? ???????????. ???????? ?? ????????? 0?04
	 eeprom_write_byte(&ee_Danke_Blinks,	0x02);	// ????????????? ?????????? ?????????? ???????? ?????? Danke. ???????? ?? ????????? 0?02
	 eeprom_write_byte(&ee_Pause_Blinks,	0x04);	// ????????????? ????? ????? ???????? ?????? ???????????. ???????? ?? ????????? 0?04 (4*10=40ms ??? 0,06 ???????)
	 eeprom_write_byte(&ee_Pause_Keys,		0x0A);	// ????????????? ????? ????? ???????? ????????? ??????. ???????? ?? ????????? 0?0A (10*10=100us ??? 0,1 ???????)
	 eeprom_write_byte(&ee_init_conf_flag,	0x04);	// ????????????? ???? 0?04, ????????, ??? ? ?????? ???????? 4-e ????????? ? ????????? ???????????? ?????????
 } 
 
	while(1) // ???????? ???? ?????????
    {
		my_key_state = Get_Key_Data();	/* 0b00100011 - ???????? ?? ?????????, ????? ? ?????? ??????????? "?????" ? ??????? ? ????????? ? +12V, ???? ????????? ?????????? ? ????????? ? ?????
											   ||||||-> ??????				1 - ???? 0 - ???
											   |||||--> ?????				1 - ???? 0 - ???
											   ||||---> ????????? ????		0 - ???? 1 - ???
											   |||----> ????? ????			0 - ???? 1 - ???
											   ||-----> ?????? ????			0 - ???? 1 - ???
											   |------> ????? ????????????	1 - ???? 0 - ??? */
		//if((my_key_state | 0b11111111) != 0b11111111) // ?????? ?? ?????? ????????? (PORTB5) - ????????, ????? ????? ?????? ??????????? ?????? ???????? ? ??????
		if((my_key_state | 0b11011111) == 0b11011111) // ?????? ?? ?????? ????????? (PORTB5)
		{
			ee_flag = 0x01;		// ??????????, ??? ?? ? ?????? ????????????
			Reset_Relay();		// ?? ?????? ???????? ???????? ????????? ???????????? ? ??????? ??????????
			Blink_Relay(0x06);	// ????? ????????????, ??????? 7 (0,1,2,3,4,5,6) ???, ?? ? ?????? ????????? ??????????? ?????????? ???????? ??????????? (uint8_t Blinks = 0x04;) - 4-? ?? ?????????.
						
			ee_counter = Get_Kurz_Lang_Counter();
			//???? ??????? ??????? ?? ?????? ??? ??????????? ???????? ??????? ????????? 254, ?? ?????????? ??????????? ???????? ??????? ? ?????? ? ????????? ? ????????? ??????????? ???????? ?????? Danke.
			if (ee_counter > 0x00) 
			{
				eeprom_write_byte(&ee_Blinks, --ee_counter);		// ????????????? ?????????? ?????????? ???????? ???????????. ???????? ?? ????????? 0?04
			}// if
			
			Reset_Relay();		// ?? ?????? ???????? ???????? ????????? ???????????? ? ??????? ??????????
			Blink_Relay(0x01);	// ??????? 2-? (0,1) ????, ? ????????? ? ????? ????????? ??????????? ?????????? ???????? ?????? Danke (uint8_t Danke_Blinks = 0x02;) - 2-a ?? ?????????.
			ee_counter = Get_Kurz_Lang_Counter();
			//???? ??????? ??????? ?? ?????? ??? ??????????? ???????? ??????? ????????? 254, ?? ?????????? ??????????? ???????? ??????? ? ?????? ? ????????? ? ????????? ??????????? ???????? ?????? Danke.
			if (ee_counter > 0x00)
			{
				eeprom_write_byte(&ee_Danke_Blinks, --ee_counter);	// ????????????? ?????????? ?????????? ???????? ?????? Danke. ???????? ?? ????????? 0?02
			} // if
			
			Reset_Relay();		// ?? ?????? ???????? ???????? ????????? ???????????? ? ??????? ??????????
			Blink_Relay(0x02);	// ??????? 3-? (0,1,2) ????, ????????? ? ????? ????????? ???????? (?????? = 10;) - 10-?? ?? ????????? (10*50=500 ???????????)
			ee_counter = Get_Kurz_Lang_Counter();
			//???? ??????? ??????? ?? ?????? ??? ??????????? ???????? ??????? ????????? 254, ?? ?????????? ??????????? ???????? ??????? ? ?????? ? ????????? ? ????????? ??????????? ???????? ?????? Danke.
			if (ee_counter > 0x00)
			{
				eeprom_write_byte(&ee_Pause_Blinks, ee_counter);	// ????????????? ?????????? ?????????? ????? ??? ????? ????? ??????????????? ??????????? ???????????. ???????? ?? ????????? 0?04
			} // if
			
			Reset_Relay();		// ?? ?????? ???????? ???????? ????????? ???????????? ? ??????? ??????????
			Blink_Relay(0x03);	// ??????? 4-? (0,1,2,3) ????, ????????? ? ????? ????????? ???????? (?????? = 10;) - 10-?? ?? ????????? (10*100=1000 ??????????? ??? 1 ????????????)
			ee_counter = Get_Kurz_Lang_Counter();
			//???? ??????? ??????? ?? ?????? ??? ??????????? ???????? ??????? ????????? 254, ?? ?????????? ??????????? ???????? ??????? ? ?????? ? ????????? ? ????????? ??????????? ???????? ?????? Danke.
			if (ee_counter > 0x00)
			{
				eeprom_write_byte(&ee_Pause_Keys, ee_counter);	// ????????????? ?????????? ?????????? ????? ??? ????? ????????????. ???????? ?? ????????? 0?0? (10)
			} // if

			Reset_Relay();
			Blink_Relay(0x06);	// ??????? 7-?? (0,1,2,3,4,5,6) ???, ???? ??????????, ??? ????? ?? ???????? ????????? ???????????????? ?????????
			ee_flag = 0x00;
		};//if
				
		not_state = Not_Blink_State();			// ???????? ?? ?????????????? ?????? ??????????? ???????????, ?.?. ???????? ???????? ????? ?????????? ? ?? ???????? ???????? ??????? ??????????? ???????? ???????? ?????? ???????????.
		if (not_state == 0x01) Reset_Relay();	// ??????? ?????????? ??????, ???????? ???????? ???????????? ????? ???????? ???????? ??? ??????? ?????????? ?????, ???????? ???????? ???????????? ?????? ???????? ????????

		if ((blink_flag & 0x08) == 0x08)		// ?????????, ??? ?? ?????????? blink_flag ? 0?08, ?.?. ??? ????????, ??? ?????????? ??????? ??????? ??? ???????? ????? "????????". 
		{
			if ((my_key_state & 0b00000111) == 0b00000011)	// ?????????, ???????? ?? ???? ? ????????? ?? ??? ???? ???????????. ???? ?????????, ? ??????????? ?????????, ?? 
			{
				Reset_Relay();
			}//if
		}//if
		else
		{
			if ((blink_flag & 0b00000111) > 0x00)						// ???-?? ???? ????????
			{
				if ((my_key_state | 0b11111011) == 0b11111011)			// ??????? ????????, ???? ??????????
				{
					if ((blink_flag & 0x03) == 0x03)					// ????????? ????????? ????? 
					{													// ???? ??? ?????????? ? ????? ????????
						my_puls = eeprom_read_byte(&ee_Danke_Blinks);	// ????? ??????????????? ?????????? ???????? "Danke_Blinks"
					} 
					else // ???? ? ?????? ???????????
					{
						my_puls = eeprom_read_byte(&ee_Blinks);			// ????? ??????????????? ?????????? ???????? "Blinks"
					}					
					if (blink_counter >= my_puls)
					{ // ???????? ?????? ?????????? ???
						PORTB		&= ~(1<<Out_Links);		// ????????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "0")
						PORTB		&= ~(1<<Out_Rechts);	// ????????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "0")
						blink_flag	= 0x08;					// ????????? ???? ??? ?????????? ????????, ??? ?????????? ? ????...
					} 
					else // ??? ?? ????????? ?????? ?????????? ???
					{
						blink_counter++;
						while ((my_key_state | 0b11111011) == 0b11111011 && not_state == 0x00) // ???????? ????????? ???? ? ???????? ?? ?????????????? ?????? ??????????? ???????????
						{
							my_key_state = Get_Key_Data();	// ?????????? ????????? ??????, ?? ???? ??? ?????? ?????????, ?? ???? ?? ???????????? ?????? ??????????? ???????????
							not_state = Not_Blink_State();	// ???????? ?? ?????????????? ?????? ??????????? ???????????
							if (not_state == 0x01) Reset_Relay();
						} // while
						// if (not_state == 0x00) {
						//	continue;
						// }
					} // else
				} // if
			} // if
			else // ?????? ?? ????????
			{
				if (blink_flag == 0x00)	// ???-?? ???? ???????? - ?????????, ??? ???? ???????? ? ????????????? ??????????????? ???? ? ????????? ??????
				{
					switch (my_key_state & 0b00000111) // ???????? ?? ?????????
					{
						case 0b00000000: // ????????? ????????? ???????????? (? ??????? ? ??????)
							PORTB			&= ~(1<<Out_Links);		// ????????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "0")
							PORTB			&= ~(1<<Out_Rechts);	// ????????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "0")
							blink_flag		= 0x08;
							break;
							
						case 0b00000111: // ????? ???????? ??? "???????"
							PORTB			|= 1<<Out_Links; 	// ???????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "1")
							PORTB			|= 1<<Out_Rechts;	// ???????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "1")
							blink_flag		= 0x03;
							blink_counter	= 0x01;
							break;
						
						//case 0b00000001: // ??????? ?????????? ?????
							//PORTB			|= 1<<Out_Links;	// ???????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "1")
							//blink_flag	= 0x01;
							//blink_counter	= 0x00;
						//break;
						
						case 0b00000101: // ??????? ?????????? ?????  ? ???? ??? ??????????
							PORTB			|= 1<<Out_Links;	// ???????? ????????? ?????? ??????????? (?????????? ? ???? ?????????? "1")
							blink_flag		= 0x01;
							blink_counter	= 0x01;
						break;
						
						//case 0b00000010: // ??????? ?????????? ??????
							//PORTB			|= 1<<Out_Rechts;	// ???????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "1")
							//blink_flag	= 0x02;
							//blink_counter	= 0x00;
						//break;

						case 0b00000110: // ??????? ?????????? ?????? ? ???? ??? ??????????
							PORTB			|= 1<<Out_Rechts;	// ???????? ????????? ??????? ??????????? (?????????? ? ???? ?????????? "1")
							blink_flag		= 0x02;
							blink_counter	= 0x01;
						break;
					} // switch
				} // if
			} // else
		} // else
    } // while
return 0;	/* return - ??? ???????????? ????????, ??????? ??????? main ?????? ??? ??????????, ????????? ? ??? int, ?? ????
			   ?? ?????? ??????? ?????. ???? ??? ??? ????? ?? ????? ??????, ?.?. ?? ???????????????? ?? main ???
			   ???????? ????? ??? ? ??????. ?????????? ????. ? ?????????? ?????? ????? ? ?? ???? ?????? ??? ?? ??????? */
} // main
